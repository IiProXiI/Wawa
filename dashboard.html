<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Information Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .info-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }
        
        .info-value {
            font-size: 18px;
            color: #333;
            font-weight: 500;
            word-break: break-all;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåê Visitor Information Dashboard</h1>
        <p class="subtitle">Educational project - Understanding HTTP headers and browser APIs</p>
        
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p>Gathering visitor information...</p>
        </div>
        
        <div id="info" style="display: none;">
            <div class="info-grid">
                <div class="info-card">
                    <div class="info-label">IP Address</div>
                    <div class="info-value" id="ip">Loading...</div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Location</div>
                    <div class="info-value" id="location">Loading...</div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Device Type</div>
                    <div class="info-value" id="device">Loading...</div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Operating System</div>
                    <div class="info-value" id="os">Loading...</div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Browser</div>
                    <div class="info-value" id="browser">Loading...</div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Screen Resolution</div>
                    <div class="info-value" id="screen">Loading...</div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Language</div>
                    <div class="info-value" id="language">Loading...</div>
                </div>
                
                <div class="info-card">
                    <div class="info-label">Timezone</div>
                    <div class="info-value" id="timezone">Loading...</div>
                </div>
            </div>
        </div>
        
        <div id="status" style="display: none;"></div>
    </div>

    <script type="module">
        // Import Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, push } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAe0PI9x-7QcLMjX4k1eW6JC18vpU61g88",
            authDomain: "visitor-tracker-73231.firebaseapp.com",
            databaseURL: "https://visitor-tracker-73231-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "visitor-tracker-73231",
            storageBucket: "visitor-tracker-73231.firebasestorage.app",
            messagingSenderId: "594221101071",
            appId: "1:594221101071:web:7e6f419f303dc2083ef37a"
        };

        // Initialize Firebase
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // Function to detect device type
        function getDeviceType() {
            const ua = navigator.userAgent;
            if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                return "Tablet";
            }
            if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                return "Mobile";
            }
            return "Desktop";
        }

        // Function to detect OS
        function getOS() {
            const ua = navigator.userAgent;
            if (ua.indexOf("Win") !== -1) return "Windows";
            if (ua.indexOf("Mac") !== -1) return "macOS";
            if (ua.indexOf("Linux") !== -1) return "Linux";
            if (ua.indexOf("Android") !== -1) return "Android";
            if (ua.indexOf("iPhone") !== -1 || ua.indexOf("iPad") !== -1) return "iOS";
            return "Unknown";
        }

        // Function to detect browser
        function getBrowser() {
            const ua = navigator.userAgent;
            if (ua.indexOf("Firefox") > -1) return "Firefox";
            if (ua.indexOf("SamsungBrowser") > -1) return "Samsung Internet";
            if (ua.indexOf("Opera") > -1 || ua.indexOf("OPR") > -1) return "Opera";
            if (ua.indexOf("Trident") > -1) return "Internet Explorer";
            if (ua.indexOf("Edge") > -1) return "Edge (Legacy)";
            if (ua.indexOf("Edg") > -1) return "Edge";
            if (ua.indexOf("Chrome") > -1) return "Chrome";
            if (ua.indexOf("Safari") > -1) return "Safari";
            return "Unknown";
        }

        // Collect visitor data
        const visitorData = {
            device: getDeviceType(),
            os: getOS(),
            browser: getBrowser(),
            screen: `${screen.width} x ${screen.height}`,
            language: navigator.language,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
            timestamp: new Date().toISOString(),
            userAgent: navigator.userAgent
        };

        // Display basic info immediately
        document.getElementById('device').textContent = visitorData.device;
        document.getElementById('os').textContent = visitorData.os;
        document.getElementById('browser').textContent = visitorData.browser;
        document.getElementById('screen').textContent = visitorData.screen;
        document.getElementById('language').textContent = visitorData.language;
        document.getElementById('timezone').textContent = visitorData.timezone;

        // Fetch IP and location info with fallback APIs
        async function fetchIPInfo() {
            // Try ipapi.co first
            try {
                const response = await fetch('https://ipapi.co/json/');
                if (response.ok) {
                    const data = await response.json();
                    return {
                        ip: data.ip,
                        city: data.city,
                        country: data.country_name,
                        countryCode: data.country_code,
                        region: data.region,
                        latitude: data.latitude,
                        longitude: data.longitude,
                        isp: data.org
                    };
                }
            } catch (error) {
                console.log('ipapi.co failed, trying backup...');
            }

            // Fallback to ipify + ipapi.com for location
            try {
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                
                // Use a CORS proxy for ip-api.com
                const locationResponse = await fetch(`https://freeipapi.com/api/json/${ipData.ip}`);
                const locationData = await locationResponse.json();
                
                return {
                    ip: ipData.ip,
                    city: locationData.cityName || 'Unknown',
                    country: locationData.countryName || 'Unknown',
                    countryCode: locationData.countryCode || 'Unknown',
                    region: locationData.regionName || 'Unknown',
                    latitude: locationData.latitude || null,
                    longitude: locationData.longitude || null,
                    isp: 'Unknown'
                };
            } catch (error) {
                console.error('All APIs failed');
                return {
                    ip: 'Unable to detect',
                    city: 'Unknown',
                    country: 'Unknown',
                    countryCode: 'Unknown',
                    region: 'Unknown',
                    latitude: null,
                    longitude: null,
                    isp: 'Unknown'
                };
            }
        }

        fetchIPInfo().then(data => {
                visitorData.ip = data.ip || 'Unknown';
                visitorData.city = data.city || 'Unknown';
                visitorData.country = data.country || 'Unknown';
                visitorData.countryCode = data.countryCode || 'Unknown';
                visitorData.region = data.region || 'Unknown';
                visitorData.latitude = data.latitude || null;
                visitorData.longitude = data.longitude || null;
                visitorData.isp = data.isp || 'Unknown';

                document.getElementById('ip').textContent = visitorData.ip;
                document.getElementById('location').textContent = 
                    `${visitorData.city}, ${visitorData.country}`;
                
                // Save to Firebase
                if (db) {
                    const visitorsRef = ref(db, 'visitors');
                    push(visitorsRef, visitorData)
                        .then(() => {
                            showStatus('Data logged successfully!', 'success');
                        })
                        .catch((error) => {
                            showStatus('Data displayed but logging failed: ' + error.message, 'error');
                        });
                }
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('info').style.display = 'block';
            })
            .catch(error => {
                console.error('Error:', error);
                visitorData.ip = 'API Error';
                visitorData.city = 'Unknown';
                visitorData.country = 'Unknown';
                
                document.getElementById('loading').style.display = 'none';
                document.getElementById('info').style.display = 'block';
                document.getElementById('ip').textContent = 'API Error';
                document.getElementById('location').textContent = 'Unable to fetch';
                
                showStatus('Unable to fetch IP information. API might be rate-limited.', 'error');
            });

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
        }
    </script>
</body>
</html>
